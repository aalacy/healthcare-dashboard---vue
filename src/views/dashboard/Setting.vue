<template>
  <v-container
      id="dashboard"
      fluid
      tag="section"
      class="min-vh"
    >
    <v-card
      class="px-5 py-3"
    >
      <v-card-title>
            Valves
            <v-spacer></v-spacer>
            <v-text-field
              v-model="search"
              append-icon="mdi-magnify"
              label="Search"
              class="mb-3 mr-3"
              single-line
              hide-details
            ></v-text-field>
              <v-btn @click="addValve" color="secondary" dark class="mb-2" ><v-icon size="16" left dark>mdi-plus</v-icon>Add Valve</v-btn>
            <v-dialog v-model="dialog" max-width="720px">
              <v-card>
                <v-card-title>
                  <span class="headline">{{ formTitle }}</span>
                </v-card-title>
                <v-card-text>
                  <v-container>
                    <v-form
                    ref="form"
                    v-model="valid"
                  >
                      <v-row>
                        <v-col
                          v-if="false"
                          cols="12"
                          md="6"
                        >
                          <v-select
                            :loading="loading"
                        v-model="editItem.username"
                        :items="members"
                        :rules="[rules.required]"
                        attach
                        chips
                        label="Select a member"
                        prepend-icon="mdi-account-outline"
                        required
                      ></v-select>
                        </v-col>
                        <v-col
                          cols="12"
                          md="6"
                        >
                          <v-text-field
                            v-model="editItem.city"
                            :rules="[rules.required]"
                            :loading="loading"
                            class="mb-5"
                            hide-details="auto"
                            label="Enter City"
                            prepend-icon="mdi-google-maps"
                            @keyup.enter="submit"
                            required
                          />
                        </v-col>

                        <v-col
                          cols="12"
                          md="6"
                        >
                          <v-text-field
                            v-model="editItem.state"
                            :rules="[rules.required]"
                            :loading="loading"
                            class="mb-5"
                            hide-details="auto"
                            label="Enter State"
                            prepend-icon="mdi-google-maps"
                            @keyup.enter="submit"
                            required
                          />
                        </v-col>

                        <v-col
                          cols="12"
                          md="6"
                        >
                          <v-text-field
                            v-model="editItem.desc"
                            :rules="[rules.required]"
                            :loading="loading"
                            class="mb-5"
                            hide-details="auto"
                            label="Enter Description"
                            prepend-icon="mdi-details"
                            @keyup.enter="submit"
                            required
                          />
                        </v-col>
                        <v-col
                          cols="12"
                          md="6"
                        >
                          <v-text-field
                            v-model="editItem.type"
                            :rules="[rules.required]"
                            :loading="loading"
                            class="mb-5"
                            hide-details="auto"
                            label="Enter Type"
                            prepend-icon="mdi-call-merge"
                            @keyup.enter="submit"
                            required
                          />
                        </v-col>
                        <v-col
                          cols="12"
                          md="6"
                        >
                          <v-text-field
                            v-model="editItem.interval"
                            :rules="[rules.required]"
                            :loading="loading"
                            class="mb-5"
                            hide-details="auto"
                            label="Enter Interval"
                            prepend-icon="mdi-call-merge"
                            @keyup.enter="submit"
                            required
                          />
                        </v-col>
                      </v-row>
                  </v-form>
                    <v-card-actions>
                      <v-spacer></v-spacer>
                      <v-btn color="secondary" text @click="close">Cancel</v-btn>
                      <v-btn color="primary" text @click="addFls">Save</v-btn>
                    </v-card-actions>
                  </v-container>
                </v-card-text>
              </v-card>
            </v-dialog>
        </v-card-title>
          <v-data-table
          :loading="loading"
          :headers="headers"
          :items="items"
          item-key="id"
          :items-per-page="5"
          :search="search"
          class="custom-alert"
          > 
            <template v-slot:item.email="{ item }">
              <span v-html="beautifyEmail(item.email)"></span>
            </template>
            <template v-slot:item.action="{ item }">
              <v-tooltip bottom>
                <template v-slot:activator="{ on }">
                  <v-btn 
                    text 
                    icon 
                    v-on="on"
                    @click.stop="configureFLS(item)"
                  >
                    <v-icon>mdi-cog</v-icon>
                  </v-btn>
                </template>
                <span>Configure</span>
              </v-tooltip>
              <v-tooltip bottom>
                <template v-slot:activator="{ on }">
                  <v-btn 
                    text 
                    icon 
                    v-on="on"
                    @click.stop="editFLS(item)"
                  >
                    <v-icon>mdi-pencil</v-icon>
                  </v-btn>
                </template>
                <span>Edit</span>
              </v-tooltip>
              <v-tooltip bottom>
                <template v-slot:activator="{ on }">
                  <v-btn 
                    text 
                    icon 
                    v-on="on"
                    @click.stop="deleteFLS(item)"
                  >
                    <v-icon>mdi-delete</v-icon>
                  </v-btn>
                </template>
                <span>Delete</span>
              </v-tooltip>
            </template>
        </v-data-table>
      </v-card>

      <v-snackbar
        v-model="snackbar"
        :color="snackColor  "
        multi-line
        top
      >
        {{snackText}}
        <v-icon
          dark
          @click="snackbar = false"
        >
          mdi-close
        </v-icon>
      </v-snackbar>

      <v-dialog v-model="modal" max-width="290">
          <v-card>
            <v-card-title class="text-center"><b>WARNING</b></v-card-title>
            <v-card-text>Are you sure?</v-card-text>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn color="red darken-1" text @click="modal = false">Disagree</v-btn>
              <v-btn color="green darken-1" text @click="_delete()">Agree</v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
  </v-container>
</template>

<script>
    import { beautifyEmail } from '../../util'
    import { Get, fetchAllControllers, createController, updateFLSListing } from '../../api'

    export default {
      name: 'Root',

      data: () => ({
        loading: false,
        valid: true,
        search: '',
        snackbar: false,
        snackColor: '',
        snackText: '',
        dialog: false,
        dateMenu: false,
        modal: false,
        items: [],
        members: [
          'admin',
          'bradcole'
        ],
        eventNames: [
          'BZW - Blizzard Warning',
          'CFA - Coastal Flood Watch',
          'CFW - Coastal Flood Warning',
          'DSW - Dust Storm Warning',
          'EWW - Extreme Wind Warning',
          'FFA - Flash Flood Watch'
        ],
        curItem: null,
        headers: [
          // {
          //  text: 'User Name',
          //  value: 'username'
          // },
          {
            text: 'Device Id',
            value: 'controller_id'
          },
          {
            text: 'Controller Location',
            value: 'location'
          },
          {
            text: 'Controller Description',
            value: 'desc'
          },
          {
            text: 'Controller Type',
            value: 'type'
          },
          {
            text: 'Controller Interval',
            value: 'interval'
          },
          { text: 'Actions', value: 'action', sortable: false },
        ],
          defaultIndex: -1,
          editItem: {
            connection_interval: 1
          },
          defaultItem: {

          },
          rules: {
            required: value => {
              return !!value || 'This field is required.'
            },
          }
      }),

      mounted () {
        this.loadControllers()  
      },

      computed: {
        formTitle () {
          return this.defaultIndex === -1 ? 'Add Valve' : 'Edit Valve'
        },
      },

      methods: {
          beautifyEmail,

          showSnack (res) {
            this.snackText = res.message
            this.snackColor = res.status
            this.snackbar = true
          },

          close () {
            this.dialog = false
          },

          configureFLS (item) {
            this.$router.push({ path: `/root/configure/${item.fls_id}`})
          },

          async loadControllers() {
            const res = await fetchAllControllers()
            this.snackText = res.message
            this.snackColor = res.status
            this.snack = true
            res.data.map(controller => {
              this.items.push({
                ...controller,
                owner: controller.owner,
                location: controller.city + ' ' +controller.state,
                type: controller.type
              })
            })
          },

          closeDialog () {
            this.dialog = false
            setTimeout(() => {
              this.defaultItem = Object.assign({}, this.defaultItem)
              this.defaultIndex = -1
            }, 300)
          },

          editFLS (item) {
              this.defaultIndex = this.items.indexOf(item)
            this.editItem = Object.assign({}, item)
            this.dialog = true
          },

          addValve () {
            this.defaultIndex = -1
            this.editItem = Object.assign({}, this.defaultItem)
            this.dialog = true
          },

          async addFls () {
            this.$refs.form.validate()
            if (!this.valid) {
              return
            }
            const item = Object.assign({}, this.editItem)
            let res = {
              status: 'success' 
            }
            if (this.defaultIndex > -1) {
                updateFLSListing(item)
            } else {
              res = await createController(item)
                // this.items.push(item)
            }
            this.closeDialog()

            this.showSnack(res)
          },

          deleteFLS (item) {
            this.curItem = item
            this.modal = true
          },

          _delete() {
            this.items = this.items.filter(item => item.id != this.curItem.id)
            this.modal = false
          }
      }
  }
</script>